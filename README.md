# Семестровый проект по проектированию высоконагруженных систем (Twitter).

## 1. Тема и целевая аудитория
### 1.1 Тип сервиса
Социальная сеть. Публикация коротких заметок (постов) в формате блога («микроблогинг»).

### 1.2 Функционал MVP
1. Регистрация
2. Авторизация
3. Создание постов (текст + прикрепленные фотографии)
    * [Максимальная длинна поста в символах - 280](https://meduza.io/news/2017/09/27/tvitter-uvelichil-dlinu-soobscheniya-v-dva-raza-do-280-simvolov#:~:text=%D0%A1%D0%B5%D1%80%D0%B2%D0%B8%D1%81%20%D0%BC%D0%B8%D0%BA%D1%80%D0%BE%D0%B1%D0%BB%D0%BE%D0%B3%D0%BE%D0%B2%20Twitter%20%D1%83%D0%B4%D0%B2%D0%BE%D0%B8%D0%BB%20%D0%BC%D0%B0%D0%BA%D1%81%D0%B8%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D1%83%D1%8E%20%D0%B4%D0%BB%D0%B8%D0%BD%D1%83%20%D1%81%D0%BE%D0%BE%D0%B1%D1%89%D0%B5%D0%BD%D0%B8%D1%8F%20%E2%80%94%20%D0%B4%D0%BE%20280%20%D1%81%D0%B8%D0%BC%D0%B2%D0%BE%D0%BB%D0%BE%D0%B2.) (Ресурс ненадёжный + новость довольно старая, поэтому также было проверено опытным путём)
    * [Максимальный размер прикреплённой к посту фотографии - 5МБ](https://help.twitter.com/ru/using-twitter/tweeting-gifs-and-pictures#:~:text=%D0%A4%D0%BE%D1%82%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D0%B8%20%D0%BC%D0%BE%D0%B3%D1%83%D1%82%20%D0%B8%D0%BC%D0%B5%D1%82%D1%8C%20%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%20%D0%B4%D0%BE%205%20%D0%9C%D0%91.)
    * [Максимальное количество прикрепленный фотографий к посту - 4](https://help.twitter.com/ru/using-twitter/tweeting-gifs-and-pictures#:~:text=%D0%9A%20%D0%BE%D0%B4%D0%BD%D0%BE%D0%BC%D1%83%20%D1%82%D0%B2%D0%B8%D1%82%D1%83%20%D0%BC%D0%BE%D0%B6%D0%BD%D0%BE%20%D0%BF%D1%80%D0%B8%D0%BA%D1%80%D0%B5%D0%BF%D0%B8%D1%82%D1%8C%20%D0%B4%D0%BE%204%20%D1%84%D0%BE%D1%82%D0%BE%D0%B3%D1%80%D0%B0%D1%84%D0%B8%D0%B9.&text=%D0%92%D1%8B%20%D1%82%D0%B0%D0%BA%D0%B6%D0%B5%20%D0%BC%D0%BE%D0%B6%D0%B5%D1%82%D0%B5%20%D0%BE%D1%82%D0%B2%D0%B5%D1%87%D0%B0%D1%82%D1%8C%20%D0%BD%D0%B0,%D0%B8%D0%BB%D0%B8%20%D0%B2%D0%B8%D0%B4%D0%B5%D0%BE%20%D0%BF%D1%80%D1%8F%D0%BC%D0%BE%20%D1%81%20%D1%82%D0%B5%D0%BB%D0%B5%D1%84%D0%BE%D0%BD%D0%B0.)
4. Возможность подписываться на другие аккаунты
5. Просмотр ленты постов
6. Возможность лайкать посты
7. Возможность оставлять комментарий под постами

### 1.3 Целевая аудитория
[По итогам второго квартала 2021 года 206 миллионов человек пользуются «Твиттером» ежедневно](https://www.statista.com/statistics/970920/monetizable-daily-active-twitter-users-worldwide/).

[За июль 2021 Твиттером воспользовались](https://www.statista.com/statistics/242606/number-of-active-twitter-users-in-selected-countries/):
* 73 миллиона жителей Америки
* 55.55 миллиона жителей Японии
* 21.1 миллиона жителей Индии


## 2. Расчет нагрузки

### 2.1 Продуктовые метрики

#### 2.1.1 Месячная аудитория 
[В среднем твиттером пользуются 330 миллионов человек в месяц](https://www.websiterating.com/ru/research/twitter-statistics/)

#### 2.1.2 Дневная аудитория 
[По итогам второго квартала 2021 года 206 миллионов человек пользуются «Твиттером» ежедневно](https://www.statista.com/statistics/970920/monetizable-daily-active-twitter-users-worldwide/).

#### 2.1.3 Средний размер хранилища пользователя
В среднем пользователь имеет 150 твиттов.

[По данным на 2012 год средняя длина поста составляет 28 символов, на отрезке [60, 140] локальный экстремум достигается при длине твитта в 140 символов](https://smk.co/article/the-average-tweet-length-is-28-characters-long-and-other-interesting-facts). Несмотря на то, что источник устарел, считаю, что от информации можно отталкиваться, ввиду человеческого фактора данной статистики (чаще всего пользователи твиттера хотят поделиться своими мыслями "в моменте", не расписывая её досконально). Возьмём среднюю длину твитта в 65 символов. Один символ занимает 1 байт памяти

Несмотря на ограничение в 5 фотографий, пользователи твиттер довольно редко прикрепляют фотографии к своим постам. Среднее количество загружаемых фотографий будем считать равными `0.7`. Средний размер фотографии будем считать равным `60000` байт

Таким образом, средний размер поста равен: `0.7 * 60000 + 65 = 42065` байт

Будем считать, что в среднем пользователь оставляет 30 комментариев. Длина каждого комментария в среднем 20 символов. Один символ занимает 1 байт памяти

Средний размер хранилища пользователя составляет `150 * 42065  + 30 * 20 = 6310350` байт = `6,31035` МБ


#### 2.1.4 Среднее количество действий пользователя по типам в день

[Всего совершается примерно 835 миллионов твиттов в день](https://www.internetlivestats.com/twitter-statistics/)
Таким образом, в среднем в день один пользователь делает: `835000000 / 206000000 ~ 4.05` твитта

[По данным на август 2021 твиттером воспользовались 6.88 миллиарда раз](https://www.similarweb.com/website/twitter.com/)

Будем считать, что при каждом заходе в твиттер пользователь в среднем один раз 'создаёт' свою ленту постов. Таким образом количество созданий ленты постов в день на пользователя: `6880000000 / 31 / 206000000 ~ 1.077` созданий ленты в сутки

Для остальных действий был использован эвристический метод (личный опыт + опыт знакомых)

##### 2.1.4.1 Таблица
| Действие       | Количество в день |
| ------------- |:------------------:|
| Регистрация   | 0.1                |
| Авторизация   | 0.25               |
| Создание постов  | 4.05         |
| Подписка на другой аккаунт  | 0.9         |
| Просмотр ленты постов (загрузка постов)  | 1.077         |
| Лайк  | 3         |
| Комментарий  | 0.48         |


### 2.2 Технические метрики
[В среднем твиттером пользуются 330 млн. человек в месяц](https://www.websiterating.com/ru/research/twitter-statistics/)


#### 2.2.1 Размер хранения в разбивке по типам данных
Как было выяснено выше, на сегодняшний день всего совершается примерно 835 миллионов твиттов в день.

По приведенному ниже скриншоту графика можно заметить, что количество твиттов начало резко возрастать с начала 2011 года и продолжает стремительно расти.

![image](https://user-images.githubusercontent.com/64415914/134597665-92bbf6e3-e1fb-4fe4-9222-6f2c70478ffc.png)

*Грубо* Посчитаем количество постов в период со старта твиттера до 2013: `50000000 * 365 * 4 + 100000000 * 365 + 200000000 * 185 + 340000000 * 274 + 500000000 * 547 = 513160000000` постов

За период с 2013 года по текущий день подобной статистики нет, колчиство твиттов в день за этот период будем считать средним между количеством твиттов в день на 2013 год и на текущий день: `(500000000 + 835000000) / 2 = 667500000` постов в день

*Грубо* Посчитаем количество постов с 2013 года по сегодняший день: `667500000 * 3188 = 2.12799e+12`

Таким образом, общее количество постов: `513160000000 + 2.12799e+12 = 2.64115e+12`

Как было выяснено выше, средний размер поста равен: `1750065` байт

Для хранения всех постов потребуется: `2.64115e+12 * 42065 = 101044.83408213127` ТБ

Будем считать, что количество комментариев в 5 раз меньше количества постов: `2.64115e+12 / 5 = 528230000000`

Для хранения всех комментариев потребуется: `528230000000  * 20 = 1.05646e+13` Байт = `9.608447726350278` ТБ

#### 2.2.2 Пиковое потребление в течении суток

Воспользуемся информацией, что всего создаётся 835 миллионов твиттов в день, а средний размер твитта составляет `42065` байт. Тогда нагрузка на создание постов в течение суток составляет: `(835000000 * 42065) / 86400 = 2.77` ГБит/c

Количество создаваемых комментариев в сутки в пять раз меньше количества постов: `835000000 / 5 = 167000000`. Нагрузка на создание комментариев в течение суток составляет: `(167000000 * 60) / 86400 = 0.000927777778` ГБит/c

### 2.2.3 RPS в разбивке по типам запросов


По расчётам таблицы из п. 2.1.4.1 получим, что среднее количество действий пользователя в сутки составляет: `0.1 + 0.25 + 4.05 + 0.9 + 1.077 + 3 + 0.48 = 9.857`. Всего 205 миллионов пользователей ежедневно. Таким образом, имеем: `(9.857 * 205000000) / 86400 ~ 23387` RPS

Расчитав коэффициенты по таблице из п. 2.1.4.1, получим:
| Действие       | RPS |
| ------------- |:------------------:|
| Регистрация   | 237                |
| Авторизация   | 593               |
| Создание постов  | 9609         |
| Подписка на другой аккаунт  | 2135         |
| Просмотр ленты постов (загрузка постов)  | 2555         |
| Лайк  | 7117         |
| Комментарий  | 1138         |


## 3. Логическая схема
![HL2_initial_logical](https://user-images.githubusercontent.com/64415914/137641990-e69b5ee2-8a17-4bcd-bb4c-7269425d7859.png)

Сущности:
* Пользователь
* Пост
* Подписка
* Лайк
* Комментарий

## 4. Физическая схема
![HL2_initial](https://user-images.githubusercontent.com/64415914/137641997-406a8393-0218-40eb-ac5f-3bf760c176bd.png)

### 4.1. Хранение Картинок:
Хранение кратинок прямо в базе является крайне плохой практикой. Вместо этого все картинки, которые прикрепляются к твиттам и комментариям будем хранить на облачном хранилище Amazon S3, а в самих строках будем хранить URL этих картинок

### 4.2. Хранение подписок:
Вместо стандартного хранения типа хранения данной таблицы "Подписчик-Цель" можно использовать стркутуру "Подписчик-ЦелИ", для ускорения поиска всех людей, на который подписан конкретный пользователь

### 4.3. Лайки:
По расчетам, нагрузка на лайки достаточно большая. Ввиду специфики хранения, а именно по сути это ключ-значение (id пользователя - id поста) - сущность лайков можно вынести в отдельную NoSQL Базу, что обеспечит прирост производительности всей системы. В качестве самой базы можно взять MongoDB.

### 4.3. Шардинг таблицы "Post"
Таблица "Post" является самой большой в проекте, которая просто не влезит в один сервер. Таблица будет храниться на нескольких серверов, структура таблицы везде одинакова.

Масштабировать базу "Post" посредством слейвов не полуится, т.к. по RPS на запись существенно больше RPS на чтение в худшем случае может получить следующую картину:

<img width="843" alt="image" src="https://user-images.githubusercontent.com/64415914/137642123-f184aaa8-bfae-4aba-9c79-0031cd049f9b.png">


#### 4.3.1 Алгоритм шардирования таблицы "Post"
Очевидно, что пользователь при формировании ленты хочет видеть самые последние твитты. В Postgres будем использовать нативно поддерживаемый Range Partitioning, основанный на дате. В одном из серверов необходимо хранить "самые свежие" посты, например, за 2 недели. Этот сервер должен быть достаточно быстрым, чтобы лента новостей могла формироваться как можно скорее. Все остальные посты нельзя хранить просто на другом сервере. Можно воспользоваться следующим алгоритмом:
* Сейчас - 2 недели
* 2 недели - 2 месяца
* 2 месяца - 6 месяцев
* 6 месяцев - год
* оставшиеся посты разбить по годам и хранить в отдельных серверах "по годам"

Также будет хорошей практикой сделать количество шардов "с запасом", когда сервер перестанет справляться с нагрузкой - можно сделать алгоритм "более дробным" по временным 

Альтернатива:
Использовать Tarantool для "Горячих" данных (https://habr.com/en/company/oleg-bunin/blog/310690/). Холодные данные будут храниться на Postgres. Преимущества: Очень быстрое формирование ленты постов

### 4.4 Индексы:
Таблица User:
Индекс на поле "Nickname" для ускорения поиска человека по его нику

Таблица Subscription:
Индекс на поле "SubscriberID" для поиска всех подписок пользователяа

Таблица Commentary:
Индекс по полю "PostID" для поиска комментариев по конкретному посту

Таблица Post:
Индекс по полю "CreatorID" для поиска постов конкретного пользователя

## 5. Технологии
Микросервисная архитектура. Так как проект является высоконагруженным - необходимо обеспечить стабильную работу всей системы даже в случае поломки одной из её частей. Недопустимо ситуация, когда из-за ошибки в функционале лайков падает весь твиттер. Возможный вариант разбивки на сервисы:

| Микросервис |
| ------------- |
| Авторизации / логина |
| Постов |
| Лайков |
| Комментариев |
| Информации о пользователях / Подписок (также занимается формированием ленты) |


| Технология       | Область применения | Мотивационная часть |
| ------------- |------------------|------------------| 
| gRPC |Весь проект|По факту ныне стандарт для больших систем. Используется HTTP2, на данный момент уже может баланситься современными балансировщиками, имеются готовые библиотеки для работы с ним, что значительно ускоряет разработку|
|Go|Весь проект, кроме микросервисов постов и лайков| Набирает стремительную популярность (не будет больших проблем с поиском кадров). На нем проще разрабатывать, чем на C/C++. Есть встроенная многопоточность|
|С++|Микросервисы постов и лайков| Данные микросервисы рискуют стать узким горлышком во всем проекте, т.к. исходя из анализы таблицы из п. 2.1.4.1 основная нагрузка идет именно на создание постов и проставление лайков|
|Kafka/RabbitMQ|Очереди для микросервисов лайков|Очевидно, что когда пользователь поставил лайк - он хочет мгновенное изменение счетчика лайков у себя на странице, но добитсья большей производитлеьности можно с помощью следующей хитрости: изменять значение лайков прямо на странице пользователя через JS, передавать информацию в очередь о том, что пользователь поставил лайк на определенный пост, затем обрабатывать сразу кучей несколько запросов (можно даже с помощью транзакий)|

## 6. Схема проекта
![HL3 drawio](https://user-images.githubusercontent.com/64415914/140653715-72e0b43c-d092-4004-aa73-98c86b36bfca.png)


